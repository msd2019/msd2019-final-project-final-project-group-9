---
title: "MSD 2019 Final Project"
subtitle: "A replication and extension of < PAPER TITLE > by < ORIGINAL AUTHORS >, < PUBLISHED IN >"
author: "Your Names (your unis)"
date: '`r Sys.time()`'
output:
  pdf_document:
    toc: yes
    toc_depth: 3
---

```{r}
library(tidyverse)
library(modelr)
library(ggplot2)
library(igraph)
library(reldist)
library(here)
library(modelr)
```

```{r read data}
fp_prefix <- "data/original/"

# Read by department data individually

business_edglist <- read.table(paste(fp_prefix, "Business_edgelist.txt", sep = ""),
  header = FALSE,
  col.names = c("u", "v", "rank", "gender")
)
business_vertexlist <- read.table(
  file = paste(fp_prefix, "Business_vertexlist.txt", sep = ""),
  sep = "	", header = FALSE,
  col.names = c("u", "pi", "USN2009", "NRC2010", "Region", "institution")
)

computer_science_edglist <- read.table(paste(fp_prefix, "ComputerScience_edgelist.txt", sep = ""),
  header = FALSE,
  col.names = c("u", "v", "rank", "gender")
)
computer_science_vertexlist <- read.table(
  file = paste(fp_prefix, "ComputerScience_vertexlist.txt", sep = ""),
  sep = "	", header = FALSE,
  col.names = c("u", "pi", "USN2009", "NRC2010", "Region", "institution")
)

history_edglist <- read.table(paste(fp_prefix, "History_edgelist.txt", sep = ""),
  header = FALSE,
  col.names = c("u", "v", "rank", "gender")
)
history_vertexlist <- read.table(
  file = paste(fp_prefix, "History_vertexlist.txt", sep = ""),
  sep = "	", header = FALSE,
  col.names = c("u", "pi", "USN2009", "NRC2010", "Region", "institution")
)

# Store data in list structure for iterations

data_list <- list(
  "Buisness" = list("edge" = business_edglist, "vert" = business_vertexlist),
  "Computer_Science" = list("edge" = computer_science_edglist, "vert" = computer_science_vertexlist),
  "History" = list("edge" = history_edglist, "vert" = history_vertexlist)
)
```


# Make a loop that uses the same code for the three departments, reads the data produces plot visualions, and sets up density plots
```{r}
top15 <- data.frame()
rest <- data.frame()
all_edgelists <- data.frame()
all_vertexes <- data.frame()
placement_data = data.frame()


for (dep in names(data_list)) {
  edgelist <- data_list[[dep]]$edge
  vertex <- data_list[[dep]]$vert

  # making a table that includes the weight of each edge
  weighted_edgelist <- edgelist %>%
    group_by(v, u) %>%
    summarize(count = n()) %>%
    ungroup() %>%
    left_join(vertex, by = c("v" = "u")) %>%
    select(v, u, count, institution)


  # fitlering the weighted edgelist to make an easier to look at plot (like in Fig. 1)
  smaller <- weighted_edgelist %>%
    filter(u <= 10, v <= 10)

  # Then plotting this network of the top schools
  smaller_graph <- smaller %>%
    graph_from_data_frame(directed = TRUE)


  plot(smaller_graph,
    vertex_size = 2, edge.width = E(smaller_graph)$count / 2,
    layout = layout_in_circle(smaller_graph, order = V(smaller_graph)),
    vertex.label = unique(E(smaller_graph)$institution),
    main = paste(dep, "Department", sep = " ")
  )


  num_schools <- max(edgelist$u)

  # making another set of the full network to make a network plot like in Fig. 3
  prestige_list <- weighted_edgelist %>%
    filter(v != num_schools, u != num_schools) %>%
    group_by(v) %>%
    summarize(
      top_school = as.double(v <= 0.15 * num_schools)[1],
      prestige = num_schools - v[1]
    ) %>%
    ungroup()


  # Setting up the network to plot Fig. 3
  graph <- weighted_edgelist %>%
    filter(u != v, u %in% prestige_list$v, v %in% prestige_list$v) %>%
    graph_from_data_frame(directed = FALSE, vertices = prestige_list)


  plot(graph,
    vertex.size = 2 + 3 * V(graph)$top_school + V(graph)$prestige / 15,
    vertex.color = 3 + V(graph)$top_school,
    vertex.label = NA,
    main = paste(dep, "Department", sep = " ")
  )


  # making dataframes of the top 15 of institutions with the differences in prestige from phd to faculty shools
  # This is to make the density plots in Fig. 3
  # Am doing rbing to keep data from all the departments, but addign the label of department first

  edgelist$dep <- dep
  vertex$dep <- dep


  top15 <- rbind(top15, edgelist %>%
    filter(u <= .15 * num_schools) %>%
    mutate(diff = (v - u) / num_schools) %>%
    select(diff, dep, rank))

  # doing the same thing for the rest of the institutions
  rest <- rbind(rest, edgelist %>%
    filter(u > .15 * num_schools) %>%
    filter(u < num_schools) %>%
    mutate(diff = (v - u) / num_schools) %>%
    select(diff, dep, rank))

  # Finding the gini coefficient for each department, using the library reldist
  school_counts <- edgelist %>%
    filter(v != num_schools) %>%
    group_by(v) %>%
    summarize(counts = n()) %>%
    ungroup()

  # Here the coefficients look very small when looking at it split by department
  G <- gini(school_counts$counts, runif(n = nrow(school_counts)))

  cat("
", dep, "Gini Coefficient:", G)


  
  
  # save all the edgelists and vertex lists into one dataframe (with the department labels) so its easy to do stuff with them outside this loop
  all_edgelists <- rbind(all_edgelists, edgelist)
  all_vertexes <- rbind(all_vertexes, vertex)
  
  
  
  
  #Setting up Figure 2 plots
 total_placements <- edgelist %>%
  filter(u < n()) %>%
  summarise(rows = n())
total_placements <- as.numeric(total_placements)



placement_data <- rbind(placement_data, edgelist %>%
  filter(u < n()) %>%
  group_by(u) %>%
  summarise(
    faculty_produced = n(),
    fraction_placements = n() / total_placements
  ) %>%
  arrange(desc(fraction_placements)) %>%
  mutate(cum_place_percent = cumsum(fraction_placements)) %>%
  mutate(fraction_schools = row_number() / n()) %>%
  mutate(dep = dep) %>%
  ungroup(edgelist) )
  
  
  

  
}
```
#Plotting Figure 2 

```{r}
x <- c(0, .5, 1)
y <- c(0, .5, 1)
equality_line <- data.frame(x, y)

placement_data %>%
  ggplot(aes(x = fraction_schools, y = cum_place_percent, color = dep)) +
  geom_point() + 
  geom_line() + 
  scale_x_continuous(breaks = seq(0, 1, by = 0.25)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.1)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_text(aes(x = .5, y = .55, label = "Equality line", angle = 40)) +
  geom_area(data = equality_line, aes(x = x, y = y), fill = "#D3D3D3") +
  xlab("Fraction of institutions") +
  ylab("Fraction of faculty produced") + 
  labs(color = "Department")


```




# Density plots for Fig 3

```{r}
# Making the density plots here

top15 %>%
  ggplot(aes(x = diff, color = dep)) +
  geom_density() +
  geom_vline(xintercept = 0, linetype = "dashed") +
  ylim(0, 2.8) +
  xlim(-.5, 1) +
  ggtitle("Top 15% of Institutions") +
  ylab("Density") +
  xlab("Relative change in rank from Ph.D Institution") +
  labs(color = "Department")


rest %>%
  ggplot(aes(x = diff, color = dep)) +
  geom_density() +
  geom_vline(xintercept = 0, linetype = "dashed") +
  ylim(0, 2.8) +
  xlim(-.5, 1) +
  ggtitle("All other Institutions") +
  ylab("Density") +
  xlab("Relative change in rank from Ph.D Institution") +
  labs(color = "Department")
```


# Analyzing the mobility of prestige for different ranks

Below are density plots of prestige change for top15 and rest while splitting by both department and rank. Plots look pretty chaotic and we should probably bet rid of these eventually, but it doesn't hurt to see how small the differences are between the splits. 

```{R}

top15 %>%
  mutate(rankdep = paste(rank, dep)) %>%
  ggplot(aes(x = diff, color = rankdep)) +
  geom_density() +
  geom_vline(xintercept = 0, linetype = "dashed") +
  ylim(0, 2.8) +
  xlim(-.5, 1) +
  ggtitle("Top 15% of Institutions") +
  ylab("Density") +
  xlab("Relative change in rank from Ph.D Institution") +
  labs(color = "Department")


rest %>%
  mutate(rankdep = paste(rank, dep)) %>%
  ggplot(aes(x = diff, color = rankdep)) +
  geom_density() +
  geom_vline(xintercept = 0, linetype = "dashed") +
  ylim(0, 2.8) +
  xlim(-.5, 1) +
  ggtitle("All other Institutions") +
  ylab("Density") +
  xlab("Relative change in rank from Ph.D Institution") +
  labs(color = "Rank and Department")
```




Here is a plot of change in prestige density for the all the data, looking at splits by faculty rank.  
Can see a slightly larger portion of "full" faculy staying within their Ph.d institution's rank. Slightly more mobility fopr Assoc and Asst, but not by much. 

```{r}

rbind(top15, rest) %>%
  ggplot(aes(x = diff, color = rank)) +
  geom_density() +
  geom_vline(xintercept = 0, linetype = "dashed") +
  ylim(0, 2.8) +
  xlim(-.5, 1) +
  ggtitle("All Institutions") +
  ylab("Density") +
  xlab("Relative change in rank from Ph.D Institution") +
  labs(color = "Rank")
```





# looking at gini cofficient with all the data, still not able ot get the number they got in the original paper

```{r}
school_counts <- all_edgelists %>%
  left_join(all_vertexes, by = c("v" = "u", 'dep' = 'dep')) %>%
  select(v, u, institution) %>%
  filter(institution != "All others") %>%
  group_by(institution) %>%
  summarize(counts = n()) %>%
  ungroup()

# Here the coefficients look very small when looking at it split by department
G <- gini(school_counts$counts)

cat("Gini Coefficient for whole dataset:", G)
```



#Making a regressor predicting the rank of the school people join frmo gender and 

```{r}

regress <- all_edgelists %>%
  mutate( y = u - v ) %>%
   left_join(all_vertexes, by = c("v" = "u", 'dep' = 'dep')) %>%
  filter(institution != "All others") %>%
  mutate( num_gender = gender == 'F') %>%
  select(y, v, num_gender)


#I could do train/test split, but the model's not very good, and we're really just doing thsi to interpret the coefficients
 model <- lm(y ~ (v + num_gender), data = regress)
 regress$pred = predict(model, regress)
 
 regress %>%
   ggplot(aes(x = v, y = y)) +
   geom_point() +
   geom_line(aes(y = pred), color = 'red') +
   ylab('Change in Rank from \nDoctoal to Faculty Institution') + 
   xlab('Doctoral Institution Rank') +
   ggtitle('Predicting Prestige Changes' )
 
 
 
cat('\ncoefficients:\n')
model$coefficients
cat('\nR squared:', summary(model)$r.squared )
#we see a pretty bad r^2 also.... kind of expected this


```

We can see that the model predicts women to go to higher prestige schools relative to their doctoral school, although only by about 4 ranks, so not a very big difference. We can also see that as people go to lower prestige schools, the model predicts they will go to higher prestige schools. Of course, this doesn't really tell the full story, since by looking at the graph we can that there are more points for the higher prestige doctoral schools (x close to 1), and this model obviously doesn't capture the people who attended s these schools but didn't go on to become faculty professors. 







The following is a list of all packages used to generate these results. (Leave at very end of file.)

```{r}
sessionInfo()
```
